# recon
spring batch for finance reconciliation

## 业务场景
财务系统每月都需要从不同合作机构拿到订单文件（包括订单号，金额），和交易系统中的进行对比。如果对账成功，会将对账成功的数据进行结算。如果对账不成功，会将错误原因记录在文件中，方便查看。这个项目的目的就是启动一个对账任务，记录对账结果。

## 业务流程
* 财务系统上传合作机构的excel文件到oss上，启动对账任务。将excel文件的链接(batch_id)，合作机构id（cooperate_org_id），对账开始结束时间(start_time,end_time)，还有唯一标识这次任务的batch_id作为启动参数。代码：BatchConfigurationTest
* 启动任务根据对账逻辑分批次进行两阶段对账
    * 第一阶段，分批次从excel中读取数据、处理、写入数据（ThirdPartStepConfig）。在写入之前，根据订单号从交易库中获取订单，并进行对账（ThirdPartStepWriterListener）。注意：在写入时要根据对账结果判断是要写入错误日志文件，对账差异文件，更新数据库中订单信息。
    * 第二阶段，从数据库里查询未时间范围内，该合作机构为对账的订单，记录到对账差异文件中。(MineStepConfig)
* 如果第一阶段发现excel中数据有问题。恢复修改了状态的订单状态到初始状态。上传错误日志文件到oss上。
* 如果对账过程中存在金额不一致的对账结果。恢复修改了状态的订单状态到初始状态。上传对账差异文件到oss上，并记录对账结果统计信息。
* 如果对账过程中不存在金额不一致的对账结果。更新所有对账一致的订单状态为对账成功，恢复所有我方有对方无的订单状态为初始状态。上传对账差异文件到oss上，并记录对账结果统计信息。

## 对账逻辑
* 读取合作机构提供的excel。如果excel中订单号或者金额字段为空或者不符合规范，对账失败。如果excel中保单号重复，对账失败。记录下导致失败的订单以及失败原因到错误文件中。
* 通过excel中的保单号从订单表中取得对应的保单。
* 如果订单表中不存在记录，在对账差异文件中记录差异原因，三方有我方无。
* 如果订单表中只有一条记录，如果金额一致，在订单表更新订单批次id。如果金额不一致，在对账差异文件中记录差异原因，金额不一致。无论是否一致，更新订单状态为对账中。
* 如果订单表中有多条记录，找到金额同excel一致的订单组合，如果未找到，在对账差异文件记录差异原因，金额不一致。如果找到了，在订单表更新这个组合订单批次id，同时将其余的订单记录到对账差异文件中，差异原因，我方有三方无。不管结果怎么样，设置这些订单状态为对账中。
* 在完成以上对账之后，查询要求时间范围内，对应的合作机构，未进行对账的订单，在对账差异文件记录这些订单，差异原因为我方有对方无。


## http启动任务
* curl -d "" localhost:8080/job/launchJob 通过发送post请求启动任务
* 访问http://localhost:8080/h2-console，设置jdbcUrl:jdbc:h2:mem:mydb 访问批次任务数据 
